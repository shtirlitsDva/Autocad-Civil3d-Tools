<UserControl x:Class="NorsynHydraulicTester.Views.Controls.FormulaDisplayControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:wpfMath="clr-namespace:WpfMath.Controls;assembly=WpfMath">

    <Grid>
        <!-- Normal Step View -->
        <StackPanel Visibility="{Binding IsSummary, Converter={StaticResource InverseBoolToVisibilityConverter}}">
            <TextBlock Text="{Binding Name}"
                       Style="{StaticResource StepHeaderStyle}"
                       FontSize="18"/>

            <TextBlock Text="{Binding Description}"
                       Foreground="{DynamicResource Text}"
                       TextWrapping="Wrap"
                       Margin="0,0,0,12"
                       Opacity="0.8"/>

            <Border Style="{StaticResource FormulaBoxStyle}">
                <StackPanel>
                    <TextBlock Text="Formel:" Style="{StaticResource FieldLabelStyle}"/>
                    <wpfMath:FormulaControl Formula="{Binding FormulaSymbolic, Converter={StaticResource LaTeXSanitizeConverter}}"
                                            Foreground="White"
                                            FontSize="16"
                                            Margin="0,8,0,0"/>
                </StackPanel>
            </Border>

            <Border Style="{StaticResource FormulaBoxStyle}">
                <StackPanel>
                    <TextBlock Text="Beregning:" Style="{StaticResource FieldLabelStyle}"/>
                    <wpfMath:FormulaControl x:Name="BeregningFormula"
                                            Formula="{Binding FormulaWithValues, Converter={StaticResource LaTeXSanitizeConverter}}"
                                            Foreground="White"
                                            FontSize="13"
                                            Margin="0,8,0,0"/>
                </StackPanel>
            </Border>

            <ItemsControl ItemsSource="{Binding Inputs}" Margin="0,8,0,0">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Background="#FF2A2A2A" CornerRadius="3" Padding="8,4" Margin="0,0,8,4">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding Symbol}" Style="{StaticResource SymbolStyle}"/>
                                <TextBlock Text="=" Foreground="{DynamicResource Text}" Margin="0,0,4,0"/>
                                <TextBlock Text="{Binding Value, Converter={StaticResource DanishNumberConverter}}" Style="{StaticResource ValueStyle}"/>
                                <TextBlock Text="{Binding Unit}" Style="{StaticResource UnitStyle}"/>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <Border Visibility="{Binding IsIterative, Converter={StaticResource BoolToVisibilityConverter}}"
                    Style="{StaticResource FormulaBoxStyle}"
                    Margin="0,8,0,0">
                <Expander Header="Iterationer" Foreground="{DynamicResource Text}">
                    <DataGrid ItemsSource="{Binding Iterations}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              IsReadOnly="True"
                              Style="{StaticResource DarkDataGridStyle}"
                              MaxHeight="200">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="#" Binding="{Binding IterationNumber}" Width="50"/>
                            <DataGridTextColumn Header="Værdi (f)" Binding="{Binding Value, Converter={StaticResource DanishNumberConverter}, ConverterParameter=N8}" Width="*"/>
                            <DataGridTextColumn Header="Fejl (|Δf|)" Binding="{Binding Error, Converter={StaticResource DanishNumberConverter}, ConverterParameter=E3}" Width="*"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Expander>
            </Border>

            <Border Style="{StaticResource ResultBoxStyle}">
                <StackPanel>
                    <StackPanel Orientation="Horizontal"
                                Visibility="{Binding Results.Count, Converter={StaticResource ZeroToVisibilityConverter}}">
                        <TextBlock Text="Resultat: " Foreground="{DynamicResource Text}" FontWeight="SemiBold" FontSize="16"/>
                        <TextBlock Text="{Binding ResultValue, Converter={StaticResource DanishNumberConverter}}"
                                   Style="{StaticResource ValueStyle}"
                                   FontSize="16"
                                   FontWeight="Bold"/>
                        <TextBlock Text="{Binding ResultUnit}"
                                   Style="{StaticResource UnitStyle}"
                                   FontSize="16"/>
                    </StackPanel>
                    <ItemsControl ItemsSource="{Binding Results}"
                                  Visibility="{Binding Results.Count, Converter={StaticResource NonZeroToVisibilityConverter}}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" Margin="0,2">
                                    <TextBlock Text="{Binding Name}" Foreground="{DynamicResource Text}" FontWeight="SemiBold" FontSize="14" MinWidth="150"/>
                                    <TextBlock Text="{Binding Symbol}" Style="{StaticResource SymbolStyle}" FontSize="14" Margin="8,0,0,0"/>
                                    <TextBlock Text=" = " Foreground="{DynamicResource Text}" FontSize="14"/>
                                    <TextBlock Text="{Binding Value, Converter={StaticResource DanishNumberConverter}}"
                                               Style="{StaticResource ValueStyle}"
                                               FontSize="14"
                                               FontWeight="Bold"/>
                                    <TextBlock Text="{Binding Unit}"
                                               Style="{StaticResource UnitStyle}"
                                               FontSize="14"/>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>
        </StackPanel>

        <!-- Summary View -->
        <StackPanel Visibility="{Binding IsSummary, Converter={StaticResource BoolToVisibilityConverter}}">
            <TextBlock Text="{Binding Name}"
                       Style="{StaticResource StepHeaderStyle}"
                       FontSize="18"/>

            <TextBlock Text="{Binding Description}"
                       Foreground="{DynamicResource Text}"
                       TextWrapping="Wrap"
                       Margin="0,0,0,12"
                       Opacity="0.8"/>

            <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="600">
                <ItemsControl ItemsSource="{Binding SummaryLines}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="#FF1E1E1E"
                                    BorderBrush="#FF3A3A3A"
                                    BorderThickness="0,0,0,1"
                                    Padding="8,6"
                                    Margin="0,0,0,2">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="30"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding StepNumber, StringFormat={}{0}.}"
                                               Foreground="#FF888888"
                                               FontSize="10"
                                               VerticalAlignment="Top"
                                               Margin="0,2,0,0"/>
                                    <StackPanel Grid.Column="1">
                                        <wpfMath:FormulaControl Formula="{Binding Formula, Converter={StaticResource LaTeXSanitizeConverter}}"
                                                                Foreground="White"
                                                                FontSize="11"/>
                                        <wpfMath:FormulaControl Formula="{Binding FormulaReturn, Converter={StaticResource LaTeXSanitizeConverter}}"
                                                                Foreground="#FFAAAAAA"
                                                                FontSize="11"
                                                                Margin="0,2,0,0"
                                                                Visibility="{Binding HasReturn, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </StackPanel>
    </Grid>
</UserControl>
